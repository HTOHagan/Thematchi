<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Golfshi — Match Odds</title>

  <!-- Masters-ish: white + green + classic type -->
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Libre+Baskerville:wght@400;700&family=Source+Sans+3:wght@400;600;700&display=swap');

    :root{
      --bg:#ffffff;
      --card:#ffffff;
      --text:#0f1f16;
      --muted:#55665c;
      --accent:#0b6b3a;
      --line:rgba(15,31,22,.12);
    }

    *{box-sizing:border-box}

    body{
      margin:0;
      background:var(--bg);
      color:var(--text);
      font-family:"Source Sans 3",system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
    }

    .container{
      max-width:760px;
      margin:0 auto;
      padding:16px 14px 40px;
    }

    header{
      text-align:center;
      padding:10px 0 8px;
    }

    h1{
      font-family:"Libre Baskerville",Georgia,serif;
      font-size:28px;
      margin:6px 0 6px;
      letter-spacing:-.2px;
    }

    .sub{
      margin:0;
      color:var(--muted);
      font-size:14px;
      line-height:1.35;
    }

    /* Cards */
    .card{
      background:var(--card);
      border:1px solid var(--line);
      border-radius:16px;
      padding:14px;
      margin:12px 0;
    }

    .hd{
      display:flex;
      align-items:center;
      gap:10px;
      flex-wrap:wrap;
      padding:6px 2px 12px;
      border-bottom:1px solid var(--line);
      margin-bottom:12px;
    }

    .bd{ padding: 2px; }

    /* “Pills” become subtle badges */
    .pill{
      font-size:13px;
      font-weight:700;
      color:var(--muted);
      border:1px solid var(--line);
      border-radius:999px;
      padding:8px 12px;
      background:#fff;
      display:inline-flex;
      align-items:center;
      gap:6px;
    }
    .pill strong{ color:var(--text); font-weight:800; }

    #userPill{ margin-left:auto; }

    .hidden{ display:none !important; }

    /* Inputs */
    label{
      font-size:12px;
      font-weight:800;
      text-transform:uppercase;
      letter-spacing:.06em;
      color:var(--accent);
      display:block;
      margin:10px 0 6px;
    }

    input,button{ font:inherit; }

    input{
      width:100%;
      padding:12px 12px;
      border-radius:14px;
      border:1px solid var(--line);
      background:#fff;
      color:var(--text);
      outline:none;
      font-size:16px;
      font-weight:700;
    }
    input:focus{
      border-color:rgba(11,107,58,.45);
      box-shadow:0 0 0 3px rgba(11,107,58,.12);
    }

    /* Buttons (matches master .btn look) */
    button{
      min-height:52px;
      padding:0 18px;
      border-radius:999px;
      background:var(--accent);
      color:#fff;
      font-weight:900;
      border:none;
      cursor:pointer;
      letter-spacing:.02em;
    }
    button.secondary{
      background:transparent;
      color:var(--accent);
      border:1px solid var(--accent);
    }
    button:disabled{ opacity:.45; cursor:not-allowed; }

    /* Segmented auth buttons */
    .seg{ display:flex; gap:10px; flex-wrap:wrap; }
    .segBtn{ flex:1; min-width:180px; }

    /* Controls */
    .metaStack{ display:flex; flex-direction:column; gap:10px; margin-top:12px; }
    .metaRow{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; }

    .controls{ display:flex; gap:10px; flex-wrap:wrap; align-items:flex-end; margin-top:12px; }
    .controls .pill{ flex:1; min-width:220px; }

    .ptsBox{ display:flex; flex-direction:column; gap:6px; min-width:160px; flex:0 0 auto; }
    .ptsBox label{ margin:0; }
    .ptsBox input{
      width:160px;
      font-size:20px;
      font-weight:900;
      text-align:center;
      padding:12px 10px;
      border-radius:999px;
    }

    .preset{ display:flex; gap:10px; flex-wrap:wrap; margin-top:12px; }
    .preset button{ min-height:46px; padding:0 14px; }

    /* Market layout */
    .market{ display:grid; grid-template-columns:1fr; gap:12px; margin-top:14px; }
    .side{
      border:1px solid var(--line);
      border-radius:16px;
      background:#fff;
      padding:14px;
    }

    .teamHead{ display:flex; align-items:center; justify-content:space-between; gap:10px; margin-bottom:8px; }
    .teamLeft{ display:flex; align-items:center; gap:12px; min-width:0; }

   .avatar{
  width:128px;
  height:128px;
  border-radius:28px; /* was 16px */
  border:1px solid var(--line);
  background:rgba(11,107,58,.06);
  overflow:hidden;
  position:relative;
  flex:0 0 auto;
}
    .avatar img{ width:100%; height:100%; object-fit:cover; display:none; }
    .avatar span{
      position:absolute; inset:0;
      display:grid; place-items:center;
      font-weight:900;
      color:var(--accent);
      letter-spacing:.05em;
    }

    .teamName{
      font-weight:900;
      font-size:18px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }

    .price{
      display:flex;
      align-items:baseline;
      gap:10px;
      margin-top:8px;
    }

    .big{
      font-size:44px;
      font-weight:950;
      letter-spacing:-.6px;
      color:var(--accent);
      line-height:1;
    }

    .small{ font-size:13px; color:var(--muted); font-weight:700; }

    .betBtn{
      width:100%;
      min-height:58px;
      font-size:18px;
      border-radius:999px;
    }

    /* Undo bar */
    .undoBar{ margin-top:12px; display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    .undoBar .pill{ flex:1; min-width:220px; }

    /* Admin */
    .adminWrap{ margin-top:10px; display:flex; justify-content:flex-end; }
    #adminBtn{
      min-height:40px;
      padding:0 14px;
      font-size:12px;
      opacity:.8;
    }

    /* Modal */
    .modalBackdrop{
      position:fixed; inset:0;
      background:rgba(0,0,0,.45);
      display:none;
      align-items:center;
      justify-content:center;
      padding:18px;
      z-index:9999;
    }
    .modalBackdrop.show{ display:flex; }
    .modal{
      width:min(520px, 100%);
      border:1px solid var(--line);
      border-radius:18px;
      background:#fff;
      padding:18px;
    }
    .modalTitle{
      font-family:"Libre Baskerville",Georgia,serif;
      font-size:20px;
      margin:0 0 10px 0;
      color:var(--text);
    }
    .modalText{
      font-size:18px;
      font-weight:800;
      margin:0 0 14px 0;
      line-height:1.35;
      color:var(--text);
    }
    .modalActions{ display:flex; gap:10px; flex-wrap:wrap; }
    .modalActions button{ flex:1; min-width:160px; }

    /* Results */
    .resultGrid{ display:grid; grid-template-columns:1fr; gap:10px; margin-top:10px; }
    .resultLine{ display:flex; gap:10px; flex-wrap:wrap; }
    .resultLine .pill{ flex:1; min-width:200px; }

    /* BIG WIN / OWE banner (bigger + obvious) */
    .bigBanner{
      margin-top:10px;
      padding:18px 16px;
      border-radius:18px;
      border:2px solid rgba(11,107,58,.25);
      background:rgba(11,107,58,.06);
    }
    .bigBannerTitle{
      font-size:40px;
      font-weight:950;
      letter-spacing:-.6px;
      color:var(--accent);
      margin:0 0 6px 0;
      line-height:1.05;
      text-transform:uppercase;
    }
    .bigBannerSub{
      font-size:18px;
      font-weight:800;
      color:var(--text);
      margin:0;
    }

    @media (max-width:540px){
      .controls{ flex-direction:column; align-items:stretch; }
      .ptsBox{ width:100%; min-width:0; }
      .ptsBox input{ width:100%; }
      .preset button{ flex:1; min-width:80px; }
      .big{ font-size:40px; }
      .bigBannerTitle{ font-size:34px; }
    }
  </style>
</head>

<body>
  <div class="container">
    <header>
      <h1>Golfshi — The Match Odds</h1>
      <div class="sub" id="matchSubtitle">Loading teams…</div>
    </header>

    <!-- AUTH -->
    <section class="card" id="authCard">
      <div class="hd">
        <div class="pill"><strong>Step 1:</strong> Sign in</div>
        <div class="pill" id="authPill"><strong>Status:</strong> not logged in</div>
      </div>

      <div class="bd">
        <label>Choose</label>
        <div class="seg">
          <button id="modeNewBtn" class="segBtn" type="button" onclick="setAuthMode('new')">New user</button>
          <button id="modeReturningBtn" class="segBtn secondary" type="button" onclick="setAuthMode('returning')">Returning user</button>
        </div>

        <div id="newUserPanel" style="margin-top:14px">
          <label>Name</label>
          <input id="newName" placeholder="Enter your name" autocomplete="name" />
          <label>PIN (4+ chars)</label>
          <input id="newPin" type="password" placeholder="Enter PIN" autocomplete="new-password" />
          <button style="margin-top:12px;width:100%" type="button" onclick="registerNewUser()">Create account</button>
        </div>

        <div id="returningUserPanel" class="hidden" style="margin-top:14px">
          <label>Name</label>
          <input id="returnName" placeholder="Enter your name" autocomplete="name" />
          <label>PIN</label>
          <input id="returnPin" type="password" placeholder="Enter PIN" autocomplete="current-password" />
          <button style="margin-top:12px;width:100%" type="button" onclick="loginReturningUser()">Login</button>
        </div>
      </div>
    </section>

    <!-- BETTING -->
    <section class="card hidden" id="betCard">
      <div class="hd">
        <div class="pill" id="statusPill"></div>
        <div class="pill" id="userPill"></div>
      </div>

      <div class="bd">
        <div class="metaStack">
          <div class="metaRow">
            <div class="pill" id="linePill"></div>
            <div class="pill" id="countPill"><strong>Market locks:</strong> <span id="countdown">—</span></div>
          </div>

          <div class="metaRow">
            <button class="secondary" type="button" onclick="logout()">Log out</button>
            <button class="secondary" type="button" onclick="viewResults()">View results</button>
          </div>
        </div>

        <!-- RESULTS PANEL -->
        <div id="resultsCard" class="card hidden" style="margin-top:14px">
          <div class="hd">
            <div class="pill"><strong>Results</strong></div>
            <div class="pill" id="resultsStatus"><strong>Status:</strong> —</div>
          </div>
          <div class="bd">
            <div class="pill" id="resultsHeadline"><strong>—</strong></div>
            <div class="resultGrid" id="resultsGrid"></div>
            <div class="pill" id="resultsMsg" style="margin-top:10px"><strong>—</strong></div>
          </div>
        </div>

        <div class="controls">
          <div class="pill" id="maxPill">
            <strong>Max <span id="maxPts">—</span> • Left:</strong> <span id="remaining">—</span>
          </div>

          <div class="ptsBox">
            <label>Points</label>
            <input id="points" type="number" min="1" value="10" />
          </div>
        </div>

        <div class="preset">
          <button class="secondary" type="button" onclick="setPts(5)">5</button>
          <button class="secondary" type="button" onclick="setPts(10)">10</button>
          <button class="secondary" type="button" onclick="setPts(20)">20</button>
          <button class="secondary" type="button" onclick="setPts(50)">50</button>
          <button class="secondary" type="button" onclick="setPts(100)">100</button>
        </div>

        <!-- Undo bar -->
        <div id="undoBar" class="undoBar hidden">
          <div class="pill" id="undoText"><strong>Undo bet:</strong> —</div>
          <button class="secondary" type="button" onclick="cancelLastBet()">Undo bet</button>
        </div>

        <!-- Teams -->
        <div class="market">
          <div class="side">
            <div class="teamHead">
              <div class="teamLeft">
                <div class="avatar">
                  <img id="imgA" alt="Team A" />
                  <span id="iniA">A</span>
                </div>
                <div class="teamName" id="teamA">Team A</div>
              </div>
            </div>

            <div class="price"><div class="big" id="pA">—</div><div class="small">implied</div></div>
            <div class="small" id="ptsA">—</div>

            <div style="margin-top:12px">
              <button id="betA" class="betBtn" type="button" onclick="openConfirm('A')">Bet on Team A</button>
            </div>
          </div>

          <div class="side">
            <div class="teamHead">
              <div class="teamLeft">
                <div class="avatar">
                  <img id="imgB" alt="Team B" />
                  <span id="iniB">B</span>
                </div>
                <div class="teamName" id="teamB">Team B</div>
              </div>
            </div>

            <div class="price"><div class="big" id="pB">—</div><div class="small">implied</div></div>
            <div class="small" id="ptsB">—</div>

            <div style="margin-top:12px">
              <button id="betB" class="betBtn secondary" type="button" onclick="openConfirm('B')">Bet on Team B</button>
            </div>

            <!-- Admin -->
            <div class="adminWrap">
              <button id="adminBtn" class="secondary" type="button" onclick="toggleAdmin()">Admin</button>
            </div>

            <div id="adminPanel" class="hidden" style="margin-top:10px">
              <div class="pill" style="margin-bottom:10px"><strong>Admin</strong></div>

              <label>Admin PIN</label>
              <input id="adminPin" type="password" placeholder="Admin PIN" autocomplete="off" />

              <div class="preset" style="margin-top:10px">
                <button type="button" onclick="setWinner('A')">Set Winner: A</button>
                <button type="button" onclick="setWinner('B')">Set Winner: B</button>
              </div>

              <div class="pill" id="adminMsg" style="margin-top:10px"><strong>Status:</strong> —</div>
            </div>
          </div>
        </div>
      </div>
    </section>
  </div>

  <!-- CONFIRM MODAL -->
  <div id="confirmBackdrop" class="modalBackdrop" onclick="backdropClick(event)">
    <div class="modal" onclick="event.stopPropagation()">
      <h2 class="modalTitle">Confirm your wager</h2>
      <p class="modalText" id="confirmText">—</p>
      <div class="modalActions">
        <button class="secondary" type="button" onclick="closeConfirm()">Cancel</button>
        <button type="button" onclick="confirmBet()">Confirm</button>
      </div>
    </div>
  </div>

  <script>
    // ✅ UPDATE THIS to your WORKING deployment URL
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbyrRGMQ6mojHHuB-9z6yMPzLI-f6WQ1hdPt8Do76q4IORROVHtXiIBDSZ-u6QjQmvlthg/exec";

    const $ = (id) => document.getElementById(id);
    let session = { name:"", pin:"" };

    // Countdown: 9:55 AM on 2/27/2026 (viewer local time)
    const LOCK_AT_LOCAL = new Date(2026, 1, 27, 9, 55, 0);

    let pendingSide = "";
    let teamsCache = { A:"Team A", B:"Team B" };

    let lastBetId = "";
    let undoUntil = 0;
    let undoTimer = null;

    function setPts(n){ $("points").value = n; }

    // Small helper: safe number formatting + field fallback
    const num = (v) => (Number.isFinite(Number(v)) ? Number(v) : 0);
    const fmt = (v) => num(v).toFixed(2);
    const pick = (obj, ...keys) => {
      for (const k of keys) {
        if (obj && obj[k] !== undefined && obj[k] !== null && obj[k] !== "") return obj[k];
      }
      return 0;
    };

    function showBetting(){
      $("authCard").classList.add("hidden");
      $("betCard").classList.remove("hidden");
      $("authPill").innerHTML = `<strong>Status:</strong> logged in`;
    }

    function showAuth(){
      $("betCard").classList.add("hidden");
      $("authCard").classList.remove("hidden");
      $("authPill").innerHTML = `<strong>Status:</strong> not logged in`;
    }

    function saveSession(){
      localStorage.setItem("golfshi_name", session.name);
      localStorage.setItem("golfshi_pin", session.pin);
    }

    function loadSession(){
      session = {
        name: localStorage.getItem("golfshi_name") || "",
        pin:  localStorage.getItem("golfshi_pin") || ""
      };
    }

    function clearSession(){
      localStorage.removeItem("golfshi_name");
      localStorage.removeItem("golfshi_pin");
      session = { name:"", pin:"" };
    }

    function setAuthMode(mode){
      const isNew = (mode === "new");
      $("newUserPanel").classList.toggle("hidden", !isNew);
      $("returningUserPanel").classList.toggle("hidden", isNew);
      $("modeNewBtn").classList.toggle("secondary", !isNew);
      $("modeReturningBtn").classList.toggle("secondary", isNew);
      setTimeout(() => {
        const el = $(isNew ? "newName" : "returnName");
        if(el) el.focus();
      }, 0);
    }

    async function apiPost(payload){
      const form = new URLSearchParams();
      for (const [k,v] of Object.entries(payload)) form.append(k, String(v));

      const r = await fetch(SCRIPT_URL, {
        method:"POST",
        headers:{ "Content-Type":"application/x-www-form-urlencoded;charset=UTF-8" },
        body: form.toString()
      });

      const j = await r.json();
      if(!j.ok) console.log("API ERROR:", payload, j);
      return j;
    }

    async function apiGet(url){
      const r = await fetch(url);
      const j = await r.json();
      if(!j.ok) console.log("API ERROR (GET):", url, j);
      return j;
    }

    async function registerNewUser(){
      const name = $("newName").value.trim();
      const pin  = $("newPin").value.trim();
      if(!name){ alert("Enter your name."); return; }
      if(!pin || pin.length < 4){ alert("PIN must be at least 4 characters."); return; }

      const res = await apiPost({ action:"register", name, pin });
      if(!res.ok){ alert(res.error || "Register failed"); return; }

      session = { name, pin };
      saveSession();
      showBetting();
      render(res.state);
      renderBalance(res.balance);
      restoreUndoUI();
      checkResultsAuto();
    }

    async function loginReturningUser(){
      const name = $("returnName").value.trim();
      const pin  = $("returnPin").value.trim();
      if(!name){ alert("Enter your name."); return; }
      if(!pin){ alert("Enter your PIN."); return; }

      const res = await apiPost({ action:"login", name, pin });
      if(!res.ok){ alert(res.error || "Login failed"); return; }

      session = { name, pin };
      saveSession();
      showBetting();
      render(res.state);
      renderBalance(res.balance);
      restoreUndoUI();
      checkResultsAuto();
    }

    function logout(){
      clearSession();
      $("newName").value = "";
      $("newPin").value = "";
      $("returnName").value = "";
      $("returnPin").value = "";
      hideUndo();
      hideResults();
      showAuth();
    }

    function initialsFromTeamName(name){
      const s = String(name || "").replace(/&/g, " ").replace(/\s+/g, " ").trim();
      if(!s) return "?";
      const parts = s.split(" ").filter(Boolean);
      const letters = [];
      for(const p of parts){
        if(p.toLowerCase() === "and" || p === "vs" || p === "v") continue;
        letters.push(p[0].toUpperCase());
        if(letters.length >= 2) break;
      }
      if(letters.length === 1 && parts.length > 1) letters.push(parts[1][0].toUpperCase());
      return letters.join("");
    }

    function setAvatar(imgEl, iniEl, url, fallbackText){
      if(url){
        imgEl.src = url;
        imgEl.style.display = "block";
        iniEl.style.display = "none";
        imgEl.onerror = () => {
          imgEl.style.display = "none";
          iniEl.style.display = "grid";
          iniEl.textContent = fallbackText;
        };
      } else {
        imgEl.style.display = "none";
        iniEl.style.display = "grid";
        iniEl.textContent = fallbackText;
      }
    }

    function setActiveSide(side){
      $("betA").classList.toggle("secondary", side !== "A");
      $("betB").classList.toggle("secondary", side !== "B");
    }

    // ---- Confirm modal ----
    function openConfirm(side){
      const pts = Number($("points").value);
      if(!Number.isFinite(pts) || pts <= 0){ alert("Enter points > 0."); return; }
      pendingSide = side;
      const team = (side === "A") ? teamsCache.A : teamsCache.B;
      $("confirmText").textContent = `You are betting ${pts} point(s) on ${team}.`;
      $("confirmBackdrop").classList.add("show");
    }
    function closeConfirm(){
      pendingSide = "";
      $("confirmBackdrop").classList.remove("show");
    }
    function backdropClick(e){
      if(e.target && e.target.id === "confirmBackdrop") closeConfirm();
    }
    async function confirmBet(){
      const side = pendingSide;
      if(!side) return;
      closeConfirm();
      await placeBet(side);
    }

    // ---- Undo bar ----
    function showUndo(betId, undoMinutes){
      const mins = Number(undoMinutes || 5);
      lastBetId = betId;
      undoUntil = Date.now() + (Math.max(1, mins) * 60 * 1000);

      localStorage.setItem("golfshi_lastBetId", lastBetId);
      localStorage.setItem("golfshi_undoUntil", String(undoUntil));

      $("undoBar").classList.remove("hidden");
      tickUndo();
      if(undoTimer) clearInterval(undoTimer);
      undoTimer = setInterval(tickUndo, 1000);
    }

    function hideUndo(){
      $("undoBar").classList.add("hidden");
      lastBetId = "";
      undoUntil = 0;
      localStorage.removeItem("golfshi_lastBetId");
      localStorage.removeItem("golfshi_undoUntil");
      if(undoTimer) clearInterval(undoTimer);
      undoTimer = null;
    }

    function tickUndo(){
      const ms = undoUntil - Date.now();
      if(ms <= 0){ hideUndo(); return; }
      const s = Math.floor(ms/1000);
      const m = String(Math.floor(s/60)).padStart(2,"0");
      const r = String(s%60).padStart(2,"0");
      $("undoText").innerHTML = `<strong>Undo bet:</strong> ${m}:${r} left`;
    }

    function restoreUndoUI(){
      const savedId = localStorage.getItem("golfshi_lastBetId") || "";
      const savedUntil = Number(localStorage.getItem("golfshi_undoUntil") || "0");
      if(savedId && savedUntil > Date.now()){
        lastBetId = savedId;
        undoUntil = savedUntil;
        $("undoBar").classList.remove("hidden");
        tickUndo();
        if(undoTimer) clearInterval(undoTimer);
        undoTimer = setInterval(tickUndo, 1000);
      } else {
        hideUndo();
      }
    }

    async function cancelLastBet(){
      const betId = lastBetId || (localStorage.getItem("golfshi_lastBetId") || "");
      const until = Number(localStorage.getItem("golfshi_undoUntil") || "0");
      if(!betId){ alert("No bet to undo."); return; }
      if(Date.now() > until){ hideUndo(); alert("Undo window expired."); return; }

      const res = await apiPost({ action:"cancelbet", name:session.name, pin:session.pin, betId });
      if(!res.ok){ alert(res.error || "Could not undo."); return; }

      hideUndo();
      render(res.state);
      renderBalance(res.balance);
      checkResultsAuto();
    }

    // ---- Betting ----
    async function placeBet(side){
      const pts = Number($("points").value);
      if(!Number.isFinite(pts) || pts <= 0){ alert("Enter points > 0."); return; }

      setActiveSide(side);

      const res = await apiPost({ action:"bet", name:session.name, pin:session.pin, side, points:pts });
      if(!res.ok){ alert(res.error || "Bet rejected"); await refresh(); return; }

      const undoMin = res.state?.config?.UNDO_MINUTES || 5;
      if(res.betId) showUndo(res.betId, undoMin);

      render(res.state);
      renderBalance(res.balance);
      checkResultsAuto();
    }

    async function refresh(){
      try{
        const st = await apiGet(`${SCRIPT_URL}?action=state&ts=${Date.now()}`);
        if(st.ok) render(st);

        if(session.name && session.pin){
          const b = await apiGet(`${SCRIPT_URL}?action=balance&name=${encodeURIComponent(session.name)}&pin=${encodeURIComponent(session.pin)}&ts=${Date.now()}`);
          if(b.ok) renderBalance(b);
          await checkResultsAuto();
        }
      }catch(e){}
    }

    function renderBalance(b){
      $("remaining").textContent = b.remaining;
      $("maxPts").textContent = b.maxPts;
    }

    function render(st){
      const locked = !!st.locked;
      const teams = st.teams || { A:"Team A", B:"Team B", A_IMG:"", B_IMG:"" };
      teamsCache = { A: teams.A, B: teams.B };

      $("teamA").textContent = teams.A;
      $("teamB").textContent = teams.B;
      $("matchSubtitle").textContent = `${teams.A} vs ${teams.B}`;

      setAvatar($("imgA"), $("iniA"), teams.A_IMG, initialsFromTeamName(teams.A));
      setAvatar($("imgB"), $("iniB"), teams.B_IMG, initialsFromTeamName(teams.B));

      $("statusPill").innerHTML = `<strong>Status:</strong> ${locked ? "LOCKED" : "OPEN"}`;
      $("userPill").innerHTML = `<strong>You:</strong> ${session.name || "—"}`;

      const o = st.odds || {pA:0.5,pB:0.5};
      const t = st.totals || {ptsA:0,ptsB:0};

      $("linePill").innerHTML = `<strong>Line:</strong> ${Math.round(o.pA*100)}/${Math.round(o.pB*100)}`;
      $("pA").textContent = Math.round(o.pA*100) + "%";
      $("pB").textContent = Math.round(o.pB*100) + "%";
      $("ptsA").textContent = `${t.ptsA} pts on A`;
      $("ptsB").textContent = `${t.ptsB} pts on B`;

      $("betA").textContent = `BET ON ${teams.A}`;
      $("betB").textContent = `BET ON ${teams.B}`;

      $("betA").disabled = locked;
      $("betB").disabled = locked;
    }

    // ---- Results ----
    function hideResults(){ $("resultsCard").classList.add("hidden"); }

    function showResults(r){
      $("resultsCard").classList.remove("hidden");

      if(!r.winner){
        $("resultsStatus").innerHTML = `<strong>Status:</strong> NOT SET`;
        $("resultsHeadline").innerHTML = `<strong>Winner not set yet.</strong>`;
        $("resultsGrid").innerHTML = "";
        $("resultsMsg").innerHTML = `<strong>${r.message || ""}</strong>`;
        return;
      }

      $("resultsStatus").innerHTML = `<strong>Status:</strong> FINAL`;
      $("resultsHeadline").innerHTML = `<strong>WINNER: ${r.winner} • LOSER: ${r.loser}</strong>`;

      const payoutPerPoint = pick(r, "payoutPerPointPts", "payoutPerPoint");
      const stakeDollars   = pick(r, "userWinnerStakeDollars", "userStakeDollars");

      const lines = [];

      lines.push(`
        <div class="resultLine">
          <div class="pill"><strong>Loser pool:</strong> ${num(r.potPts)} pts ($${fmt(r.potDollars)})</div>
          <div class="pill"><strong>Winner pool:</strong> ${num(r.winPoolPts)} pts</div>
        </div>
      `);

      lines.push(`
        <div class="resultLine">
          <div class="pill"><strong>Payout / 1 winner pt:</strong> ${fmt(payoutPerPoint)} pts</div>
          <div class="pill"><strong>$ / point:</strong> $${fmt(r.dollarsPerPoint)}</div>
        </div>
      `);

      lines.push(`
        <div class="resultLine">
          <div class="pill"><strong>Your winner pts:</strong> ${num(r.userWinnerPts)}</div>
          <div class="pill"><strong>Your loser pts:</strong> ${num(r.userLoserPts)}</div>
        </div>
      `);

      if(num(r.userWinnerPts) > 0){
        lines.push(`
          <div class="resultLine">
            <div class="pill"><strong>Your payout:</strong> ${fmt(r.userPayoutPts)} pts ($${fmt(r.userPayoutDollars)})</div>
            <div class="pill"><strong>Your stake:</strong> $${fmt(stakeDollars)}</div>
          </div>
        `);
        lines.push(`
          <div class="resultLine">
            <div class="pill"><strong>Net:</strong> $${fmt(r.userNetDollars)}</div>
            <div class="pill"><strong>Message:</strong> ${r.message || ""}</div>
          </div>
        `);
      } else if(num(r.userLoserPts) > 0){
        lines.push(`
          <div class="resultLine">
            <div class="pill"><strong>You owe:</strong> $${fmt(r.oweDollars)}</div>
            <div class="pill"><strong>Message:</strong> ${r.message || ""}</div>
          </div>
        `);
      } else {
        lines.push(`
          <div class="resultLine">
            <div class="pill"><strong>Message:</strong> ${r.message || "No bets by you."}</div>
          </div>
        `);
      }

      // Big banner at top of results (very visible)
      let bannerHtml = "";
      if(num(r.userWinnerPts) > 0){
        bannerHtml = `
          <div class="bigBanner">
            <div class="bigBannerTitle">YOU WON</div>
            <div class="bigBannerSub">Net: $${fmt(r.userNetDollars)} • You receive: $${fmt(r.userTotalReceivedDollars)}</div>
          </div>
        `;
      } else if(num(r.userLoserPts) > 0){
        bannerHtml = `
          <div class="bigBanner">
            <div class="bigBannerTitle">YOU OWE</div>
            <div class="bigBannerSub">Amount due: $${fmt(r.oweDollars)}</div>
          </div>
        `;
      }

      $("resultsGrid").innerHTML = bannerHtml + lines.join("");
      $("resultsMsg").innerHTML = `<strong>${r.message || ""}</strong>`;
    }

    async function viewResults(){
      if(!session.name || !session.pin){ alert("Login first."); return; }
      const r = await apiGet(`${SCRIPT_URL}?action=results&name=${encodeURIComponent(session.name)}&pin=${encodeURIComponent(session.pin)}&ts=${Date.now()}`);
      if(!r.ok){ alert(r.error || "Could not load results"); return; }
      showResults(r);
    }

    async function checkResultsAuto(){
      if(!session.name || !session.pin) return;
      try{
        const r = await apiGet(`${SCRIPT_URL}?action=results&name=${encodeURIComponent(session.name)}&pin=${encodeURIComponent(session.pin)}&ts=${Date.now()}`);
        if(r && r.ok && r.winner) showResults(r);
      }catch(e){}
    }

    // ---- Admin ----
    function toggleAdmin(){
      const panel = $("adminPanel");
      if(!panel) return;
      panel.classList.toggle("hidden");
      const pin = $("adminPin");
      if(pin && !panel.classList.contains("hidden")) pin.focus();
    }

    async function setWinner(winner){
      const adminPin = ($("adminPin")?.value || "").trim();
      if(!adminPin){ alert("Enter admin PIN"); return; }

      const msg = $("adminMsg");
      if(msg) msg.innerHTML = `<strong>Status:</strong> Setting winner…`;

      const res = await apiPost({ action:"setwinner", winner, adminPin });

      if(!res.ok){
        if(msg) msg.innerHTML = `<strong>Status:</strong> ${res.error || "Failed"}`;
        alert(res.error || "Failed");
        return;
      }

      if(msg) msg.innerHTML = `<strong>Status:</strong> Winner set to ${winner}`;
      await refresh();
      await viewResults();
    }

    // ---- Countdown ----
    function fmtCountdown(ms){
      if(ms <= 0) return "LOCK TIME";
      const totalSec = Math.floor(ms/1000);
      const d = Math.floor(totalSec / 86400);
      const h = Math.floor((totalSec % 86400) / 3600);
      const m = Math.floor((totalSec % 3600) / 60);
      const s = totalSec % 60;
      const hh = String(h).padStart(2,"0");
      const mm = String(m).padStart(2,"0");
      const ss = String(s).padStart(2,"0");
      return d > 0 ? `${d}d ${hh}:${mm}:${ss}` : `${hh}:${mm}:${ss}`;
    }
    function tickCountdown(){
      const ms = LOCK_AT_LOCAL.getTime() - Date.now();
      $("countdown").textContent = fmtCountdown(ms);
    }

    (async function boot(){
      setAuthMode("returning");
      showAuth();

      tickCountdown();
      setInterval(tickCountdown, 1000);

      // preload market even if logged out
      try{
        const st = await apiGet(`${SCRIPT_URL}?action=state&ts=${Date.now()}`);
        if(st.ok) render(st);
      }catch(e){}

      loadSession();
      if(session.name && session.pin){
        const res = await apiPost({ action:"login", name:session.name, pin:session.pin });
        if(res.ok){
          showBetting();
          render(res.state);
          renderBalance(res.balance);
          restoreUndoUI();
          checkResultsAuto();
        } else {
          clearSession();
          showAuth();
        }
      }
    })();

    setInterval(()=>{ if(!$("betCard").classList.contains("hidden")) refresh(); }, 5000);
  </script>
</body>
</html>
