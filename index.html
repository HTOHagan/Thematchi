/** Golfshi backend (Sheets + Apps Script Web App) â€” NAME + PIN
 *  GET  ?action=state
 *  GET  ?action=balance&name=Tom&pin=1234
 *  POST {action:"register", name, pin}
 *  POST {action:"login", name, pin}
 *  POST {action:"bet", name, pin, side:"A"|"B", points:int}
 *  POST {action:"lock", locked:true|false}           // (admin optional; still open unless you later restrict)
 */

const SHEET_BETS = "Bets";
const SHEET_CONFIG = "Config";
const SHEET_USERS = "Users";

function doGet(e) {
  const action = (e.parameter.action || "state").toLowerCase();
  if (action === "state") return jsonResponse(getState());

  if (action === "balance") {
    const name = String(e.parameter.name || "").trim();
    const pin  = String(e.parameter.pin || "").trim();
    if (!name) return jsonResponse({ ok:false, error:"Name required" }, 400);
    if (!pin)  return jsonResponse({ ok:false, error:"PIN required" }, 400);
    if (!authUser(name, pin)) return jsonResponse({ ok:false, error:"Bad name/PIN" }, 403);
    return jsonResponse(getBalance(name));
  }

  return jsonResponse({ ok:false, error:"Unknown action" }, 400);
}

function doPost(e) {
  let body = {};
  try { body = JSON.parse(e.postData.contents || "{}"); } catch (err) {}
  const action = (body.action || "").toLowerCase();

  if (action === "register") return jsonResponse(registerUser(body));
  if (action === "login")    return jsonResponse(loginUser(body));
  if (action === "bet")      return jsonResponse(placeBet(body));
  if (action === "lock")     return jsonResponse(setLocked(body));

  return jsonResponse({ ok:false, error:"Unknown action" }, 400);
}

// ---------------- Users ----------------

function registerUser(body) {
  const name = normalizeName(body.name);
  const pin  = String(body.pin || "").trim();

  if (!name) return { ok:false, error:"Name required" };
  if (!pin)  return { ok:false, error:"PIN required" };
  if (pin.length < 4) return { ok:false, error:"PIN must be at least 4 digits/chars" };

  const sh = SpreadsheetApp.getActive().getSheetByName(SHEET_USERS);
  if (!sh) return { ok:false, error:"Missing Users sheet" };

  if (userExists(name)) {
    return { ok:false, error:"Name already registered. Use Login." };
  }

  sh.appendRow([name, hashPin(pin), new Date()]);
  return { ok:true, message:"Registered", state:getState(), balance:getBalance(name) };
}

function loginUser(body) {
  const name = normalizeName(body.name);
  const pin  = String(body.pin || "").trim();

  if (!name) return { ok:false, error:"Name required" };
  if (!pin)  return { ok:false, error:"PIN required" };

  if (!authUser(name, pin)) return { ok:false, error:"Bad name/PIN" };

  return { ok:true, message:"Logged in", state:getState(), balance:getBalance(name) };
}

function authUser(name, pin) {
  const sh = SpreadsheetApp.getActive().getSheetByName(SHEET_USERS);
  if (!sh) throw new Error("Missing Users sheet");
  const values = sh.getDataRange().getValues(); // header + rows

  const target = normalizeName(name).toLowerCase();
  const hp = hashPin(pin);

  for (let i = 1; i < values.length; i++) {
    const n = String(values[i][0] || "").trim().toLowerCase();
    const h = String(values[i][1] || "").trim();
    if (n === target) return h === hp;
  }
  return false;
}

function userExists(name) {
  const sh = SpreadsheetApp.getActive().getSheetByName(SHEET_USERS);
  const values = sh.getDataRange().getValues();
  const target = normalizeName(name).toLowerCase();
  for (let i = 1; i < values.length; i++) {
    const n = String(values[i][0] || "").trim().toLowerCase();
    if (n === target) return true;
  }
  return false;
}

// ---------------- Betting ----------------

function placeBet(body) {
  const cfg = readConfig();
  if (cfg.LOCKED === true) return { ok:false, error:"Market is locked" };

  const name = normalizeName(body.name);
  const pin  = String(body.pin || "").trim();
  const side = String(body.side || "").toUpperCase();
  const points = Number(body.points);

  if (!name) return { ok:false, error:"Name required" };
  if (!pin)  return { ok:false, error:"PIN required" };
  if (!authUser(name, pin)) return { ok:false, error:"Bad name/PIN" };

  if (side !== "A" && side !== "B") return { ok:false, error:"Side must be A or B" };
  if (!Number.isFinite(points) || points <= 0) return { ok:false, error:"Points must be > 0" };

  const maxPts = Number(cfg.MAX_POINTS);
  const spent = pointsSpentBy(name);
  const remaining = maxPts - spent;
  if (points > remaining) return { ok:false, error:`You only have ${remaining} points left (max ${maxPts})` };

  const sh = SpreadsheetApp.getActive().getSheetByName(SHEET_BETS);
  if (!sh) return { ok:false, error:"Missing Bets sheet" };

  sh.appendRow([new Date(), name, side, Math.floor(points)]);
  return { ok:true, state:getState(), balance:getBalance(name) };
}

function setLocked(body) {
  const locked = !!body.locked;
  writeConfigValue("LOCKED", locked ? "TRUE" : "FALSE");
  return { ok:true, state:getState() };
}

// ---------------- State / math ----------------

function getState() {
  const cfg = readConfig();
  const totals = totalPoints();
  const pA = impliedPA(totals.ptsA, totals.ptsB, Number(cfg.LIQUIDITY), Number(cfg.BASE_LINE));
  const pB = 1 - pA;

  const fav = (pA === pB) ? null : (pA > pB ? "A" : "B");
  const favProb = (fav === "A") ? pA : (fav === "B") ? pB : 0.5;
  const edgePts = Math.max(0, Math.round((favProb - 0.5) * 100));
  const spreadPts = Math.round(Math.abs(pA - pB) * 100);
  const triggers = spreadPts >= Number(cfg.THRESHOLD_PTS);
  const extraIfFavLoses = triggers ? edgePts * Number(cfg.DOLLARS_PER_POINT) : 0;

  return {
    ok: true,
    locked: cfg.LOCKED === true,
    teams: { A: cfg.TEAM_A, B: cfg.TEAM_B },
    config: {
      MAX_POINTS: Number(cfg.MAX_POINTS),
      BASE_LINE: Number(cfg.BASE_LINE),
      LIQUIDITY: Number(cfg.LIQUIDITY),
      THRESHOLD_PTS: Number(cfg.THRESHOLD_PTS),
      DOLLARS_PER_POINT: Number(cfg.DOLLARS_PER_POINT),
      DINNER_COST: Number(cfg.DINNER_COST),
    },
    totals,
    odds: { pA, pB, spreadPts, fav, edgePts, triggers, extraIfFavLoses }
  };
}

function getBalance(name) {
  const cfg = readConfig();
  const maxPts = Number(cfg.MAX_POINTS);
  const spent = pointsSpentBy(name);
  const remaining = Math.max(0, maxPts - spent);
  return { ok:true, name: normalizeName(name), maxPts, spent, remaining };
}

function impliedPA(ptsA, ptsB, L, baseLine) {
  const vA = L * baseLine;
  const vB = L * (1 - baseLine);
  const denom = (ptsA + vA) + (ptsB + vB);
  if (denom <= 0) return 0.5;
  return (ptsA + vA) / denom;
}

function totalPoints() {
  const sh = SpreadsheetApp.getActive().getSheetByName(SHEET_BETS);
  if (!sh) return { ptsA:0, ptsB:0, total:0 };
  const values = sh.getDataRange().getValues();
  let ptsA = 0, ptsB = 0;
  for (let i = 1; i < values.length; i++) {
    const side = String(values[i][2] || "").toUpperCase();
    const pts = Number(values[i][3]) || 0;
    if (side === "A") ptsA += pts;
    if (side === "B") ptsB += pts;
  }
  return { ptsA, ptsB, total: ptsA + ptsB };
}

function pointsSpentBy(name) {
  const sh = SpreadsheetApp.getActive().getSheetByName(SHEET_BETS);
  if (!sh) return 0;
  const values = sh.getDataRange().getValues();
  const target = normalizeName(name).toLowerCase();
  let spent = 0;
  for (let i = 1; i < values.length; i++) {
    const n = String(values[i][1] || "").trim().toLowerCase();
    const pts = Number(values[i][3]) || 0;
    if (n === target) spent += pts;
  }
  return spent;
}

// ---------------- Config ----------------

function readConfig() {
  const sh = SpreadsheetApp.getActive().getSheetByName(SHEET_CONFIG);
  if (!sh) throw new Error("Missing Config sheet");

  const data = sh.getDataRange().getValues();
  const map = {};
  for (let i = 0; i < data.length; i++) {
    const k = String(data[i][0] || "").trim();
    const v = data[i][1];
    if (k) map[k] = v;
  }

  return {
    MAX_POINTS: Number(map.MAX_POINTS || 100),
    LOCKED: String(map.LOCKED || "FALSE").toUpperCase() === "TRUE",
    BASE_LINE: Number(map.BASE_LINE || 0.55),
    LIQUIDITY: Number(map.LIQUIDITY || 60),
    THRESHOLD_PTS: Number(map.THRESHOLD_PTS || 20),
    DOLLARS_PER_POINT: Number(map.DOLLARS_PER_POINT || 2),
    DINNER_COST: Number(map.DINNER_COST || 300),
    TEAM_A: String(map.TEAM_A || "Team A"),
    TEAM_B: String(map.TEAM_B || "Team B"),
  };
}

function writeConfigValue(key, value) {
  const sh = SpreadsheetApp.getActive().getSheetByName(SHEET_CONFIG);
  const data = sh.getDataRange().getValues();
  for (let i = 0; i < data.length; i++) {
    if (String(data[i][0]).trim() === key) {
      sh.getRange(i+1, 2).setValue(value);
      return;
    }
  }
  sh.appendRow([key, value]);
}

// ---------------- Helpers ----------------

function normalizeName(name) {
  return String(name || "").trim().replace(/\s+/g, " ");
}

function hashPin(pin) {
  // salt stored in Script Properties (generated once)
  const props = PropertiesService.getScriptProperties();
  let salt = props.getProperty("GOLFSHI_SALT");
  if (!salt) {
    salt = Utilities.getUuid();
    props.setProperty("GOLFSHI_SALT", salt);
  }
  const bytes = Utilities.computeDigest(
    Utilities.DigestAlgorithm.SHA_256,
    (salt + "|" + String(pin)),
    Utilities.Charset.UTF_8
  );
  return bytes.map(b => ('0' + (b & 0xFF).toString(16)).slice(-2)).join('');
}

function jsonResponse(obj, code) {
  return ContentService
    .createTextOutput(JSON.stringify(obj))
    .setMimeType(ContentService.MimeType.JSON);
}
